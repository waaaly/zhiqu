<template>
    <view class="container">
    <form bindsubmit="bindSave">
    <view class="form-box">
        <view class="row-wrap">
            <view class="label">è”ç³»äºº</view>
            <view class="label-right">
                <input id="1" name="contact" class="input" maxlength="13" type="text" placeholder="å§“å" value="{{addressEdit.name}}" bindinput="getInput"/>
            </view>
        </view>
        <view class="row-wrap">
            <view class="label">è”ç³»æ‰‹æœº</view>
            <view class="label-right">
                <input id="2" name="mobile" class="input" maxlength="11" type="number" placeholder="11ä½æ‰‹æœºå·ç " value="{{addressEdit.mobile}}" bindinput="getInput"/>
            </view>
        </view>
        <view class="row-wrap" >
            <view class="label">æ‰€åœ¨åœ°åŒº</view>
              <view wx:if="{{addressEdit.full_region===''}}" @tap='selectDistrict' class="picker hui" >ç‚¹å‡»é€‰æ‹©æ‰€åœ¨åœ°åŒº</view>
              <view bindtap="selectDistrict" class="picker" wx:esle>
                {{addressEdit.full_region}}
              </view>
        </view>
        <view style="{{showArea==false?'display:none':''}}" class="row-wrap" >
            <view class="label">å¯æœåŠ¡çš„åŒºåŸŸ</view>
            <view wx:if="{{areaList.length==0}}" style="color:#ff6b5d;">æ‚¨å‘¨å›´æš‚æ²¡æœ‰å¯æä¾›æœåŠ¡çš„å•†å®¶å‘¢ï½</view>
            <view else wx:for="{{areaList}}">
                <view class="{{areaid==item.area_id?'areaItemChoose':'areaItem'}}" @tap="chooseArea({{item.area_id}},{{item.area_name}})">{{item.area_name}}</view>
            </view>
        </view>
        <view class="addr-details">
            <view class="label">è¯¦ç»†åœ°å€</view>
            <view class="label-right">
                <textarea name="address" auto-height placeholder="æ›´è¯¦ç»†çš„åœ°å€å°è¶£èƒ½æ›´å¥½çš„æœåŠ¡å“¦ï½"  value="{{addressEdit.address}}" id="3" bindinput="getInput"/>
            </view>
        </view>
        <view class="row-wrap">
            <view class="label">è®¾ä¸ºé»˜è®¤åœ°å€</view>
            <view style='position:fixed;left:120px;'>
              <checkbox-group bindchange="checkboxChange">
                <checkbox disabled="{{disDefault}}" value="flase" checked="{{addressEdit.is_default}}" ></checkbox>
              </checkbox-group>
            </view>
        </view>
    </view>
    <button  class="save-btn" formType="submit">ä¿å­˜</button>
    <button type="default" class="save-btn" bindtap="deleteAddress" data-id="{{addressData.id}}" wx:if="{{addressData}}">åˆ é™¤è¯¥åœ°å€</button>
    <button type="default" class="cancel-btn" bindtap="bindCancel">å–æ¶ˆ</button>
    </form>
</view>

  <view class="picker-view" animation="{{animationAddressMenu}}" style="visibility:{{addressMenuIsShow ? 'visible':'hidden'}}">
  <view style="height:10% ;width:95%;margin-top:10rpx">
    <text catchtap="cityCancel">å–æ¶ˆ</text>
    <text style="float: right; color:#09bb07;" catchtap="citySure">ç¡®å®š</text>
  </view>
  <!--"å¯ä»¥æ˜¾ç¤ºé»˜è®¤çš„åŸå¸‚ï¼Œä½¿ç”¨åçº§è”é€‰æ‹©åŸå¸‚ååº”å¾ˆæ…¢å°±ä¸ä½¿ç”¨äº†-->
  <picker-view style="width: 100%; height: 300px;" bindchange="cityChange" value="{{value}}" wx:key="">
    <picker-view-column>
      <view wx:for="{{provinces}}" class="picker-item">
        {{item.name}}</view>
    </picker-view-column>
    <picker-view-column>
      <view wx:for="{{citys}}" class="picker-item" wx:key="">
        {{item.name}}</view>
    </picker-view-column>
    <picker-view-column>
      <view wx:for="{{areas}}" class="picker-item" wx:key="">
        {{item.name}}</view>
    </picker-view-column>
  </picker-view>
</view>
</template>
<script>
import wepy from "wepy";
import http from '../utils/Base';
import api from '../utils/API';
var CITY = require('../utils/City.js');

var animation;
export default class addressAdd extends wepy.page{
    config = {
        "navigationBarTitleText": "æ·»åŠ åœ°å€"
    };
   data = {
        isVisible: false,
        animationData: {},
        animationAddressMenu: {},
        addressMenuIsShow: false,
        value: [0, 0, 0],//ğŸ‘‡ä¸‰ä¸ªå½“å‰é€‰æ‹©çš„å„è‡ªæ‰€åœ¨æ•°ç»„çš„ä¸‹æ ‡
        provinces: [],//å­˜å‚¨å…¨éƒ¨çœä»½/ç›´è¾–å¸‚
        citys: [],//å­˜å‚¨å½“å‰çœä»½ä¸‹çš„åŸå¸‚/ç›´è¾–å¸‚å°±æ˜¯ç›´è¾–å¸‚
        areas: [],//å­˜å‚¨å½“å‰åŸå¸‚/ç›´è¾–å¸‚ä¸‹çš„åŒº
        disDefault:true,//é»˜è®¤åœ°å€æ˜¯å¦ç¦æ­¢å‹¾é€‰
        addressEdit:{
            id: 0,//åœ°å€id
            name: "",//è”ç³»äººåç§°
            mobile: "",//æ‰‹æœºå·
            full_region: '',//çº§è”åœ°å€
            address: "",//æ‰‹åŠ¨å¡«å†™çš„è¯¦ç»†åœ°å€
            is_default: 1,//æ˜¯å¦é»˜è®¤åœ°å€
            province_id: 110000,//çœid
            province_name: "åŒ—äº¬å¸‚",//çœå/ç›´è¾–å¸‚å
            city_id:110100,//åŸå¸‚id
            city_name:"å¸‚è¾–åŒº",//åŸå¸‚åç§°
            country:"ä¸­å›½",//å›½ç±
            country_id:1,//å›½å®¶id
            district_id:110101,//åŒºdi
            district_name:"ä¸œåŸåŒº",//åŒºå   
        },
        userAddressInServer:[],//åå°ä¿å­˜çš„åœ°å€æ•°ç»„
        showArea:false,// æ˜¯å¦æ˜¾ç¤ºæœåŠ¡åŒº
        areaList:[],//æœåŠ¡åŒºåŸŸåˆ—è¡¨
        areaid:NaN,//å½“å‰é€‰æ‹©çš„æœåŠ¡åŒºåŸŸ
        areaname:'',
   } 
   onLoad(options){
       var that = this;
        wx.showToast({
        title: "åŠ è½½ä¸­",
        icon: 'loading',
        duration: 1000
        })
        if (options.title) {
        //ä¿®æ”¹é¡µé¢æ ‡é¢˜
            wx.setNavigationBarTitle({
                title: options.title
            })
        }
        /*ç”¨æˆ·åœ¨åœ°å€åˆ—è¡¨ç‚¹å‡»ç¼–è¾‘åœ°å€*/
        if (options.address) {
            var temp = JSON.parse(options.address);  
            this.addressEdit= temp; 
            this.disDefault = false;//å¯ä»¥å‹¾é€‰é»˜è®¤åœ°å€
            this.showArea = true;//æ˜¾ç¤ºæœåŠ¡åŒºåŸŸ
            this.areaid = this.addressEdit.area_id;
        }
        /*ç”¨æˆ·åœ¨é¦–é¡µå®šä½æºå¸¦å½“å‰åœ°å€ä¼ è¿‡æ¥*/
        if (options.currentAddress) {     
            this.addressEdit.address = options.currentAddress;       
        }
        // åˆå§‹åŒ–åŠ¨ç”»å˜é‡
        var animation = wx.createAnimation({
            duration: 500,
            transformOrigin: "50% 50%",
            timingFunction: 'ease',
        })
        that.animation = animation;

        // é»˜è®¤è”åŠ¨æ˜¾ç¤ºåŒ—äº¬
        var id = CITY.provinces[0].id    
        that.provinces= CITY.provinces
        that.citys= CITY.citys[id]
        that.areas= CITY.areas[CITY.citys[id][0].id]
        
        //è¯»å–åå°çš„åœ°å€æ•°æ®
       
        http.get(api.AddressList,{user_id:wx.getStorageSync('userInfoInServer').id}).then(res=>{
            console.log(res);
            this.userAddressInServer = res;
            this.$apply();   
        })
  }
     // æ‰§è¡ŒåŠ¨ç”»
    startAddressAnimation (isShow) {
        console.log(isShow);
        var that = this;
        if (isShow) {
        this.animation.translateY(0 + 'vh').step()
        } else {
        this.animation.translateY(40 + 'vh').step()
        }
        
        this.animationAddressMenu = this.animation.export();
        this.addressMenuIsShow = isShow;    
    }
    hideCitySelected (e) {
        // console.log(e)
        this.startAddressAnimation(false)
    }
    
   methods = {
       //æäº¤ä¿å­˜
        bindSave: function (e) {
            var that = this;
            console.log(e);
            var linkMan = e.detail.value.linkMan;
            var address = e.detail.value.address;
            var mobile = e.detail.value.mobile;
            
            if (linkMan == "") {
            wx.showModal({
                title: 'æç¤º',
                content: 'è¯·å¡«å†™è”ç³»äººå§“å',
                showCancel: false
            })
            return
            }
            else if (mobile == '') {
            wx.showModal({
                title: 'è¯·è¾“å…¥æ‰‹æœºå·ï¼',
                icon: 'success',
                duration: 1500
            })
            return false;
            }
            else if (mobile.length != 11) {
            wx.showModal({
                title: 'æ‰‹æœºå·é•¿åº¦æœ‰è¯¯ï¼',
                icon: 'success',
                duration: 1500
            })
            return false;
            }
            var myreg = /^(((13[0-9]{1})|(14[0-9]{1})|(15[0-9]{1})|(19[0-9]{1})|(18[0-9]{1})|(17[0-9]{1}))+\d{8})$/;
            if (!myreg.test(mobile)) {
            wx.showModal({
                title: 'æ‰‹æœºå·æ ¼å¼æœ‰è¯¯ï¼',
                icon: 'success',
                duration: 1500
            })
            return false;
            }
            else if (this.data.selProvince == "è¯·é€‰æ‹©") {
            wx.showModal({
                title: 'æç¤º',
                content: 'è¯·é€‰æ‹©çœä»½',
                showCancel: false
            })
            return
            }
            else if (this.data.areaInfo === "") {
            wx.showModal({
                title: 'æç¤º',
                content: 'è¯·é€‰æ‹©æ‰€åœ¨åœ°åŒº',
                showCancel: false
            })
            return
            }
            else if (this.data.areaname === "") {
                let tips = 'æ‚¨æ‰€åœ¨åœ°åŒºæš‚æ— æœåŠ¡,æ¢ä¸ªåœ°æ–¹è¯•è¯•ï½';
                if(this.areaList.length!=0){
                    tips = "è¯·é€‰æ‹©æœåŠ¡åŒºåŸŸ"
                }
                wx.showModal({
                    title: 'æç¤º',
                    content: tips,
                    showCancel: false
                })
                return
            }
            else if (address == "") {
            wx.showModal({
                title: 'æç¤º',
                content: 'è¯·å¡«å†™è¯¦ç»†åœ°å€',
                showCancel: false
            })
            return
            }
    
            //æ–°å¢åœ°å€
            if(this.data.addressEdit.id==0){
                var obj = {
                    name: this.addressEdit.name,
                    mobile: this.addressEdit.mobile,
                    province: this.provinces[this.value[0]].name,
                    province_id: this.provinces[this.value[0]].id,
                    city: this.citys[this.value[1]].name,
                    city_id: this.citys[this.value[1]].id,
                    district: this.areas[this.value[2]].name,         
                    district_id: this.areas[this.value[2]].id,
                    address: this.addressEdit.address,         
                    is_default: this.addressEdit.is_default,
                    area_id:this.areaid,
                    area_name:this.areaname,
                    user_id:wx.getStorageSync('userInfoInServer').id
                }
                http.post(api.AddressSave,{...obj}).then(res=>{
                     if(res.id){
                        wx.showToast({
                            title:'æ–°å¢åœ°å€æˆåŠŸ',
                        });
                        if(res.is_default){
                            wx.setStorageSync('userDefaultAddress',res);
                        }
                        setTimeout(()=>{
                            wx.navigateBack();
                        },500)
                    }else{
                        wx.showToast({
                            title:'ä¿å­˜åœ°å€å¤±è´¥ï¼',
                        })
                    } 
                })                             
            }       
            /*ä¿®æ”¹å¹¶ä¿å­˜åœ°å€*/
            else{
                console.log(that.data.addressEdit);
            
                var obj = {
                    id:  that.data.addressEdit.id,
                    name: this.addressEdit.name,
                    mobile: this.addressEdit.mobile,
                    province: this.provinces[this.value[0]].name,
                    province_id: this.provinces[this.value[0]].id,
                    city: this.citys[this.value[1]].name,
                    city_id: this.citys[this.value[1]].id,
                    district: this.areas[this.value[2]].name,
                    district_id: this.areas[this.value[2]].id,
                    address: this.addressEdit.address,
                    is_default: this.addressEdit.is_default,
                    area_id:this.areaid,
                    area_name:this.areaname,
                    user_id:wx.getStorageSync('userInfoInServer').id
                };
                http.post(api.AddressSave,{...obj}).then(res=>{
                    console.log(res);
                    wx.showToast({
                        title: "ä¿®æ”¹æˆåŠŸ",
                        duration: 1000
                    })
                    if(obj.is_default){
                        wx.setStorageSync('userDefaultAddress', obj);
                    }
                    wx.navigateBack({
                    })
                })                         
                }    
        },
        //ç‚¹å‡»å–æ¶ˆ
        bindCancel(e){
            wx.navigateBack({
                delta: 1, // å›é€€å‰ delta(é»˜è®¤ä¸º1) é¡µé¢
            })
        },
        //è·å–inputè¾“å…¥çš„æ–‡æœ¬
        getInput:function (e){
            // console.log(e.currentTarget.id);
            // console.log(e.detail.value);

            switch (parseInt(e.currentTarget.id)){
                case 1: 
                     this.addressEdit.name = e.detail.value;
                break;
                case 2:
                    this.addressEdit.mobile = e.detail.value;
                break;
                case 3:
                    this.addressEdit.address = e.detail.value;
                break;
            }
        },
        checkboxChange: function (event) {
            var str = "addressEdit.is_default";
            console.log(event)
            if (event.detail.value.length==0){
                this.addressEdit.is_default = 0;
            }
            else{
            this.addressEdit.is_default = 1;
            } 
        },
        // ç‚¹å‡»æ‰€åœ¨åœ°åŒºå¼¹å‡ºé€‰æ‹©æ¡†
        selectDistrict: function (e) {
            var that = this;
            if (that.addressMenuIsShow) {
            return
            }
            that.startAddressAnimation(true);
        },
        // å¤„ç†çœå¸‚å¿è”åŠ¨é€»è¾‘
        cityChange (e) {
            console.log(e)
            var value = e.detail.value
            var provinces = this.data.provinces
            var citys = this.data.citys
            var areas = this.data.areas
            var provinceNum = value[0]
            var cityNum = value[1]
            var countyNum = value[2]
            if (this.data.value[0] != provinceNum) {
            var id = provinces[provinceNum].id
            
                this.value = [provinceNum, 0, 0],
                this.citys = CITY.citys[id],
                this.areas = CITY.areas[CITY.citys[id][0].id];
            
            } else if (this.data.value[1] != cityNum) {
            var id = citys[cityNum].id
           
                this.value = [provinceNum, cityNum, 0],
                this.areas = CITY.areas[citys[cityNum].id];
            
            } else {
            
                this.value = [provinceNum, cityNum, countyNum]
            
            }
            // console.log(this.data)
         },
        // ç‚¹å‡»åœ°åŒºé€‰æ‹©å–æ¶ˆæŒ‰é’®
        cityCancel: function (e) {
            this.startAddressAnimation(false)
        },
        // ç‚¹å‡»åœ°åŒºé€‰æ‹©ç¡®å®šæŒ‰é’®
        citySure: function (e) {         
            var that = this;         
            var city = that.data.city;
            var value = that.data.value;
            that.startAddressAnimation(false);

            // å°†é€‰æ‹©çš„åŸå¸‚ä¿¡æ¯æ˜¾ç¤ºåˆ°è¾“å…¥æ¡†
            var areaInfo = that.data.provinces[value[0]].name + '-' + that.data.citys[value[1]].name + '-' + that.data.areas[value[2]].name;
            
            //ä¿å­˜åŸå¸‚é€‰æ‹©ç»“æœ
            that.addressEdit.full_region= areaInfo;
            //æäº¤æ‰€åœ¨åŒºåŸŸï¼Œè·å¾—æä¾›æœåŠ¡çš„åŒºåŸŸ
            http.get(api.GetShopArea,{district:that.data.areas[value[2]].name}).then(res=>{
                console.log(res)
                this.areaList = res;
                this.showArea = true;
                this.$apply();
            })
        },
        //ç‚¹å‡»æœåŠ¡åŒºåŸŸ
        chooseArea(id,name){
            this.areaid = id;
            this.areaname = name;
            this.$apply();
        }
   }
}
</script>

<style>
page{
    height: 100%;
}
.container{
    background-color: #f5f5f9;
    justify-content: initial;
}
.form-box{
    width:100%;
    background-color: #fff;
    margin-top: 20rpx;
}
.row-wrap{
    width: 720rpx;
    height: 88rpx;
    line-height: 88rpx;
    margin-left: 30rpx;
    border-bottom: 1rpx solid #eee;
    display: flex;
    font-size: 28rpx;
    /*justify-content: space-between;*/
}
.row-wrap .label{
    width: 185rpx;
    color: #333;
}
.row-wrap .label-right{
    flex: 1;
    height: 88rpx;
    line-height: 88rpx;
}
.row-wrap .label-right input{
    height: 100%;
    font-size: 28rpx;
    padding-right: 30rpx;
}
.row-wrap .right-box{
    margin-right: 30rpx; 
}
.arrow-right{
    width: 15rpx;
    height: 24rpx;
}

.cancel-btn{
    width: 690rpx;
    height: 80rpx;
    line-height: 80rpx;
    text-align: center;
    margin-top:30rpx; 
    border-radius: 6rpx;
    box-sizing: border-box;
} 
.save-btn{
    background-color: #ff6b5d;
    color:#fff;
    width: 690rpx;
    height: 80rpx;
    line-height: 80rpx;
    text-align: center;
    margin-top:30rpx; 
    border-radius: 6rpx;
    box-sizing: border-box;
}
/* button[type="default"]{
    background-color: #ffffff;
    color:#000;
} */
.addr-details{
    height: auto;
    padding: 30rpx 0;
    margin-left:30rpx;
    border-bottom: 1rpx solid #eee;
    display: flex;
    font-size: 28rpx;
}
.addr-details .label{
    margin:auto 0 auto 0;
    width: 160rpx;
    color: #333
}
.addr-details textarea{
    box-sizing: border-box;
    width: 480rpx;
    overflow: scroll;
}
picker {
    min-width: 20rpx;
    height: 100%;
    margin-right: 20rpx;
}
.hui{
    color: #777;
}
.picker-view {
  width: 100%;
  display: flex;
  z-index:12;
  background-color: #fff;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: fixed;
  bottom: 0rpx;
  left: 0rpx;
  height: 40vh;
}

.picker-item {
  line-height: 70rpx;
  margin-left: 5rpx;
  margin-right: 5rpx;
  text-align: center;
}

.areaList{
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  border-bottom: 1px solid #eee;
}

.areaItem{
  line-height:34px;
  flex: 0 0 18%;
  font-size: 13px;
  text-align: center;
  border: 1px solid #eee;
  margin: 5px;
  
  border-radius: 5px;
  background-color: rgba(200, 200, 200, 0.1);
}
.areaItemChoose{
  line-height:34px;
  flex: 0 0 18%;
  font-size: 13px;
  text-align: center;
  border: 1px solid #eee;
  margin: 5px;
  color: white;
  border-radius: 5px;
  background-color: #ff6b5d;
}
</style>
